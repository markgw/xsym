Conneau trainer
~~~~~~~~~~~~~~~

.. py:module:: langsim.modules.embedding_map.conneau.adversarial

+------------+---------------------------------------------------+
| Path       | langsim.modules.embedding_map.conneau.adversarial |
+------------+---------------------------------------------------+
| Executable | yes                                               |
+------------+---------------------------------------------------+

Learns a mapping between two monolingual vector spaces without any seed mappings.

Implementation of training algorithm from:

|   *Word Translation Without Parallel Data (2017).*
|   Alexis Conneau, Guillaume Lample, Marc'Aurelio Ranzato, Ludovic Denoyer, Herv\'e J\'egou
|

Note that the preprocessing makes use of item frequencies, so if they're not available in the
input embeddings it might not work as well.

Parameters generally default to the values given in the paper.

There are quite a number of details that are unclear from the paper, so I've had to make an arbitrary
decision about how to implement them. The method seems to be working, so either I chose correctly or
they don't matter.


Inputs
======

+----------+---------------------------------------------------------------+
| Name     | Type(s)                                                       |
+==========+===============================================================+
| vectors1 | :class:`Embeddings <pimlico.datatypes.embeddings.Embeddings>` |
+----------+---------------------------------------------------------------+
| vectors2 | :class:`Embeddings <pimlico.datatypes.embeddings.Embeddings>` |
+----------+---------------------------------------------------------------+

Outputs
=======

+-----------------+----------------------------------------------------------+
| Name            | Type(s)                                                  |
+=================+==========================================================+
| model           | :class:`~pimlico.datatypes.keras.KerasModelBuilderClass` |
+-----------------+----------------------------------------------------------+
| mapped_vectors  | :class:`~pimlico.datatypes.embeddings.Embeddings`        |
+-----------------+----------------------------------------------------------+
| mapping         | :class:`~pimlico.datatypes.arrays.NumpyArray`            |
+-----------------+----------------------------------------------------------+
| vectors2_mapped | :class:`~pimlico.datatypes.embeddings.Embeddings`        |
+-----------------+----------------------------------------------------------+

Options
=======

+----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------+
| Name                 | Description                                                                                                                                                                                                                                                                                                                                                     | Type                            |
+======================+=================================================================================================================================================================================================================================================================================================================================================================+=================================+
| min_freq             | Minimum frequency of word in original dataset for it to be included in training. Default: 5 (asin paper)                                                                                                                                                                                                                                                        | int                             |
+----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------+
| weeding_freq         | Number of iterations to perform between each time we weed out the least promising models. Default: 1                                                                                                                                                                                                                                                            | int                             |
+----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------+
| decay                | Level of decay in training. Default: 0.95 (as in paper)                                                                                                                                                                                                                                                                                                         | float                           |
+----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------+
| discriminator_words  | Number of most frequent words to draw discriminator samples from. Default: 50k (as in paper)                                                                                                                                                                                                                                                                    | int                             |
+----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------+
| dropout              | Level of dropout noise to apply to input embeddings. Default: 0.1 (as in paper)                                                                                                                                                                                                                                                                                 | float                           |
+----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------+
| val_crit_lr_red      | Halve LR every time val crit decreases between iterations. Default: True                                                                                                                                                                                                                                                                                        | bool                            |
+----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------+
| language_ids         | Comma-separated list of IDs to use for the two models that we're mapping into a common space. When the mapped space is output, words are distinguished using these IDs. If not given, numeric IDs are used by default                                                                                                                                           | comma-separated list of strings |
+----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------+
| orthogonality        | Whether to apply orthogonality constraint between updates. If 0, don't apply constraint. Otherwise, value specifies beta parameter. Default: 0.01 (as in paper)                                                                                                                                                                                                 | float                           |
+----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------+
| batch                | Batch size for training of discriminator and mapping                                                                                                                                                                                                                                                                                                            | int                             |
+----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------+
| iteration_samples    | How many samples constitute a single epoch. It's unclear from the paper what 'epoch' means, since the data is being sampled, rather than iterated over. You might want to set this to the same as discriminator_words, which seems to make sense, but I suspect they used a high value. Default: 200k                                                           | int                             |
+----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------+
| lr                   | Learning rate for SGD updates. Default: 0.1 (as in paper)                                                                                                                                                                                                                                                                                                       | float                           |
+----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------+
| discriminator_layers | List of layer sizes for discriminator. Does not include input (embedding size) or output(single value). Default: 2048,2048 (as in paper)                                                                                                                                                                                                                        | comma-separated list of ints    |
+----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------+
| iterations           | Number of complete training epochs. Fewer might be completed if early stopping is enabled                                                                                                                                                                                                                                                                       | int                             |
+----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------+
| smoothing            | Smoothing coefficient for discriminator predictions. Default: 0.2 (as in paper)                                                                                                                                                                                                                                                                                 | float                           |
+----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------+
| tolerance            | Number of iterations to continue training without an improvement in the validation criterion. If we perform this number of operations without the val crit increasing, give up and stop. Set to 0 to disable early stopping altogether. Default: 5                                                                                                              | int                             |
+----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------+
| k                    | K parameter for CSLS metric used in computing unsupervised validation criterion                                                                                                                                                                                                                                                                                 | int                             |
+----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------+
| num_starts           | Number of different models to initialize and start training. After each training iteration (for every model), half of the models are thrown away, based on the validation criterion, keeping just the most promising. After a few iterations, just a single model is left and this is trained to completion. It is best to set this to a power of 2. Default: 8 | int                             |
+----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------------------+

